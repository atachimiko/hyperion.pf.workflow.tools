XMI2STM
============================


# ビルド方法

## 開発ビルド

`Xmi2Stm.sproj`があるフォルダで下記コマンドを実行します。

```
$ dotnet build
```

## プロダクションビルド

`Xmi2Stm.sproj`があるフォルダで下記コマンドを実行します。

```
$ dotnet publish -c Release -f netcoreapp2.0 -r linux-x64
```

# 使用方法

```
Xmi2Stm.exe <XMIファイルパス>
```

`output`フォルダが生成され、ワークフローソースコードファイルが作成されます。

# 状態遷移図の作成方法

    詳しくはSample.astaファイルを参照してください。

## 状態遷移図

Astahを使用し、状態遷移図を作成する。

> 図中の「ステートマシン図0」は、astahファイル名です。
> astahファイル名に規定はありません。

![Workflow_UserManual1](/assets/Workflow_UserManual1.png)

ルート階層配下に、「パッケージ」→「状態遷移図」という構造で作成する。

このパッケージ(`Pixstock.DraemonPackage`)内には、複数の状態遷移図を定義できる。
Pixstockでは、「UMLのパッケージ＝Pixstockのファウンデーション」という位置づけとする。

1つのファウンデーションで、複数の状態遷移図を定義できる。

## 名前空間の指定方法

パッケージを作成し、タグ付き値にnamespaceを指定します。

![Workflow_UserManual2](/assets/Workflow_UserManual2.png)

## ステートマシン図の追加方法

ワークフローは、ステートマシン図に記述します。
作成したステートマシン図の「状態マシン名」が、ツールにより生成される際のクラス名となります。

![Workflow_UserManual3](/assets/Workflow_UserManual3.png)

## 画面状態遷移ワークフローの作成方法

画面状態遷移ワークフローとしたいステートマシン図を選択し、「タグ付き値」に下記の設定を行います。

```
FrameTransition=true
```
![Workflow_UserManual5](/assets/Workflow_UserManual5.png)

### 画面制御状態

画面状態遷移ワークフローでは、図中のアクティビティに画面制御状態を設定することで画面を制御するロジックとのマッピングが行われ、自動的に画面の表示／非表示処理が追加されます。

画面制御状態を設定するには、下記図のように状態名に「FRM:<コンテナ名＞」を付与します。
「コンテナ名」は自動的にプリフィックス（Pixstock.Applus.Containers.）が付与された状態でソースコードが生成されます。

![Workflow_UserManual6](/assets/Workflow_UserManual6.png)


# 実装

フレームワーク内での特殊なイベント処理以外は、状態遷移で処理するイベントハンドラはasync非同期処理で行われます。Fireメソッドの呼び出し元では、awaitによりイベント処理の完了を待つことができます。

一方、フレームワークはコンテントの切り替えで発生するイベント処理の完了は待ちません。
これは、コンテント切替イベントが完了していないにも関わらず、フレームワークが管理するコンテントの状態が切り替わる事を意味しており、コンテント状態と切替イベントの呼び出しタイミングは同期していないため注意が必要です。
